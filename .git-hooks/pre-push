#!/usr/bin/env bash
set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Step 1: Clean compile and check for warnings
echo -e "${YELLOW}[pre-push]${NC} Clean compiling..."

compile_output=$(./mill clean __.compile && ./mill __.compile 2>&1) || {
    echo ""
    echo -e "${RED}╔══════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║           COMPILATION FAILED                    ║${NC}"
    echo -e "${RED}╠══════════════════════════════════════════════════╣${NC}"
    echo -e "${RED}║ Fix compilation errors before pushing.          ║${NC}"
    echo -e "${RED}║                                                 ║${NC}"
    echo -e "${RED}║ Bypass with --no-verify (not recommended).      ║${NC}"
    echo -e "${RED}╚══════════════════════════════════════════════════╝${NC}"
    exit 1
}

if echo "$compile_output" | grep -q '\[warn\]'; then
    echo ""
    echo -e "${RED}╔══════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║           COMPILATION WARNINGS FOUND            ║${NC}"
    echo -e "${RED}╠══════════════════════════════════════════════════╣${NC}"
    echo -e "${RED}║ Fix all warnings before pushing.                ║${NC}"
    echo -e "${RED}║                                                 ║${NC}"
    echo -e "${RED}║ Warnings:                                       ║${NC}"
    echo "$compile_output" | grep '\[warn\]' | while IFS= read -r line; do
        echo -e "${RED}║  $line${NC}"
    done
    echo -e "${RED}║                                                 ║${NC}"
    echo -e "${RED}║ Bypass with --no-verify (not recommended).      ║${NC}"
    echo -e "${RED}╚══════════════════════════════════════════════════╝${NC}"
    exit 1
fi

echo -e "${GREEN}[pre-push] Compilation passed with no warnings.${NC}"

# Step 2: Run tests
echo -e "${YELLOW}[pre-push]${NC} Running tests..."

if ./mill __.test 2>&1; then
    echo -e "${GREEN}[pre-push] All tests passed.${NC}"
else
    echo ""
    echo -e "${RED}╔══════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║           TESTS FAILED                          ║${NC}"
    echo -e "${RED}╠══════════════════════════════════════════════════╣${NC}"
    echo -e "${RED}║ Fix failing tests before pushing.               ║${NC}"
    echo -e "${RED}║   ./mill __.test                                ║${NC}"
    echo -e "${RED}║                                                 ║${NC}"
    echo -e "${RED}║ Bypass with --no-verify (not recommended).      ║${NC}"
    echo -e "${RED}╚══════════════════════════════════════════════════╝${NC}"
    exit 1
fi
